# Сквозная аутентификация мобильного приложения и backend

В современных условиях использование мобильных устройств для доступа к корпоративным системам является востребованным и уже абсолютно типовым сценарием. Например, сотрудник, находясь в офисе или же за пределами корпоративной сети, должен иметь возможность с мобильного телефона оперативно получить данные о последних сделках, состоянии склада, статусе выполнения заказа и пр. В многих случаях подобная информация хранится в backend-системах внутри периметра предприятия. Соответственно, возникают задачи:

1. аутентификации корпоративного пользователя в мобильном приложении;
2. обеспечения прозрачного доступа пользователя, успешно прошедшего проверку, к необходимым backend-системам.

В одной из [предыдущих](https://xakep.ru/2018/06/08/azure-mfa/) публикаций рассматривалось решение первой задачи на основе [Azure Active Directory](https://docs.microsoft.com/en-us/azure/active-directory/active-directory-whatis) (Azure AD) для мобильных приложений, созданных с помощью [Xamarin Forms](https://www.xamarin.com/forms). Здесь же мы обсудим реализацию второй задачи – защищенного доступа к backend с использованием результатов аутентификации из п. 1.

Действующие лица и исполнители:

- В качестве системы аутентификации и управления токенами, как уже очевидно, будет выступать Azure AD. Предполагается, что для каждого пользователя, нуждающегося в мобильном доступе, в Azure AD создана учетная запись. Если необходимо использовать учетные записи локальной службы AD предприятия, можно настроить различные [варианты синхронизации](https://docs.microsoft.com/en-us/azure/active-directory/choose-hybrid-identity-solution) между AD и Azure AD.
- Мобильным приложением послужит пример кода на Xamarin из упомянутой выше статьи. Там же вы найдете все шаги по регистрации приложения в Azure AD.
- Backend-система будет представлять собой простой REST API сервис, написанный на Node.js и запущенный на CentOS. Это сервис поддерживает в базе данных MongoDB некий список абстрактных задач (а по сути, просто строк) и реализует три операции со списком: получить список задач для пользователя (listTasks), добавить задачу (createTasks), удалить задачу (removeTasks).

Как и для Xamarin в случае мобильного приложения, для Node.js доступна реализация библиотеки [Azure Active Directory Authentication Libraries](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-authentication-libraries) (ADAL), которая возьмет на себя всю рутину по взаимодействию с Azure AD, как то: защищенное обращение к облачным endpoints, проверка сертификатов, вызовы сервисов многофакторной аутентификации, если необходимо, и пр.


## Процесс аутентификации на базе Azure AD

Существует [несколько](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-authentication-scenarios#native-application-to-web-api) сценариев аутентификации с использованием Azure AD. В данном случае нас интересует вариант доступа нативного приложения к Web API, который описывается следующей диаграммой:

![Authentication flow](https://github.com/ashapoms/AzureADNodeJsXamarin/blob/master/img/native_app_to_web_api.png)

Однако при использовании библиотек подобным ADAL некоторые шаги скрыты от разработчика, поэтому ниже я дам несколько упрощенное описание, которое тем не менее отражает основную логику происходящего. Итак:

1. Пользователь запускает приложение на своем смартфоне. Это приложение обращается к Azure AD и как бы говорит: «Я – такое-то приложение, вот мой Application ID (он же по-другому называется Client ID). Дай мне токен для доступа к Web API вот с таким Application ID». Эти Application ID генерируются в процессе регистрации мобильного приложения и Web API в Azure AD.
2. Первое, что делает Azure AD, получив такой запрос, аутентифицирует пользователя, запустившего приложение. На экране телефона появляется окно для ввода логина и пароля. Если на пользователя распространяется политика многофакторной аутентификации, после корректного ввода пароля задействуется дополнительный фактор, например, на телефон высылается SMS с кодом.
3. После успешной аутентификации пользователя Azure AD проверяет, зарегистрированы ли в ее базе Application IDs мобильного приложения и Web API, иными словами, «знает ли» она эти приложения.
4. Если все в порядке, Azure AD проверяет, а разрешен ли доступ мобильному приложению к запрашиваемому Web API.
5. Если доступ разрешен, Azure AD формирует токен в формате JWT, в поле **audience** токена копирует содержимое поля **App ID URI** из регистрационных настроек Web API, подписывает токен и возвращает мобильному приложению.
6. Мобильное приложение обращается к Web API, поместив в Authorization header полученный от Azure AD токен. Поскольку токен подписан, но по умолчанию не зашифрован, предполагается, что взаимодействие между мобильным приложением и Web API осуществляется по HTTPS.
7. Получив запрос, Web API проверяет подпись и срок действия токена. Сертификат для проверки подписи доступен с публичного endpoint Azure AD.
8. Если токен в порядке, Web API сравнивает значение поля **audience** токена со своей конфигурационной информацией (файл *config.js* в нашем случае). Если найдено совпадение, Web API «понимает», что токен действительно предназначен для него, и что можно предоставлять запрашиваемую информацию.

Теперь давайте посмотрим, как эти шаги реализуются в коде и настройках Azure AD. Полностью, включая код мобильного приложения, пример доступен в моем [репозитории](https://github.com/ashapoms/AzureADNodeJsXamarin) на GitHub.


## Настройка сервиса REST API на Node.js

Оставляю за кадром процесс инсталляции Node.js и MongoDB, здесь нет никаких особенностей. Замечу лишь, что в рассматриваемом примере обе компоненты развернуты на одном хосте, и для MongoDB использовались установки и endpoints по умолчанию. Предполагаю также, что на хост с Node.js и MongoDB скопирован код из моего репозитория из папки [RestApiServer/node-server/](https://github.com/ashapoms/AzureADNodeJsXamarin/tree/master/RestApiServer/node-server).

Первым делом регистрируем Web API в Azure AD. Если нет учетной записи и доступа к [Microsoft Azure](https://azure.microsoft.com/), можно легко получить бесплатную пробную учетную запись [здесь](https://azure.microsoft.com/ru-ru/free/). В рамках пробной подписки большое число сервисов предоставляется бесплатно на год.

На портале управления Azure заходим в **Azure Active Directory** -> **App registrations** и щелкаем **New application registration**.

![Application registration](https://github.com/ashapoms/AzureADNodeJsXamarin/blob/master/img/AzureADAppRegistration.PNG)

На странице **Create** даем приложению более-менее понятное имя, например *NodeJSBearerRestServer*, в поле **Application type** выбираем *Web app / API*, в поле **Sign-on URL** задаем  http://localhost:3000 (в нашем примере REST API слушает по порту 3000, можно конечно использовать другой порт) и нажимаем **Create**.

![Create WebApi](https://github.com/ashapoms/AzureADNodeJsXamarin/blob/master/img/CreateWebApiApp.PNG)

Регистрация выполнена. Для последующей настройки сервиса REST API нам потребуется некоторая информация из Azure AD. Щелкаем на только что созданном приложении, нажимаем **Settings**, копируем и где-нибудь сохраняем значения двух важных параметров: **Application ID**

![ApplicationID](https://github.com/ashapoms/AzureADNodeJsXamarin/blob/master/img/ApplicationID.PNG)

и **App ID URI**.

![AppIDURI](https://github.com/ashapoms/AzureADNodeJsXamarin/blob/master/img/AppIDURI.PNG)
